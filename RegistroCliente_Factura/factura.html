<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Factura - Modric Estudio</title>
    <link rel="stylesheet" href="factura.css" />
  </head>
  <body>
    <div class="contenedor-factura">
      <header>
        <div class="logo">
          <img src="../imagenes/logo.png" alt="Ejemplo Carn칠 Estudiantil" />
        </div>
        <div class="info-empresa">
          <p><strong>Borcelle</strong></p>
          <p>Panam치,<br />La Chorrera</p>
          <p>Modricestudio@gmail.com</p>
        </div>
        <div class="info-factura">
          <p><strong>FACTURA N췈:</strong> <span id="numeroFactura"></span></p>
          <p><strong>Fecha:</strong> <span id="fechaFactura"></span></p>
        </div>
      </header>

      <section class="datos">
        <div class="col">
          <h3>Datos cliente</h3>
          <p id="clienteNombre"></p>
          <p id="clienteDireccion"></p>
          <p id="clienteCorreo"></p>
          <p id="clienteTelefono"></p>
        </div>
      </section>

      <table class="tabla-productos">
        <thead>
          <tr>
            <th>Descripci칩n / Producto</th>
            <th>Base</th>
            <th>ITBMS</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="tablaProductos"></tbody>
      </table>
      <section class="comentario">
        <h3>Comentario del cliente</h3>
        <p id="comentarioCliente">No se ingres칩 ning칰n comentario.</p>
      </section>

      <div class="total">
        <p><strong>Total:</strong> <span id="totalFactura"></span></p>
        <!-- NUEVO: Secci칩n de detalles de pago (abono) -->
        <div id="detallesPago" style="display: none; margin-top: 15px; padding: 12px; background-color: #fff3e0; border-radius: 5px; border-left: 4px solid #ff9800;">
          <p style="margin: 5px 0;"><strong>Detalles de Pago (Abono):</strong></p>
          <p style="margin: 5px 0; color: #666;">Monto Abonado: <strong id="montoAbonado">$0.00</strong></p>
          <p style="margin: 5px 0; color: #ff9800;"><strong>Saldo Pendiente: <span id="saldoPendiente">$0.00</span></strong></p>
        </div>
      </div>

      <footer>
        <p>
          El pago se realizar치 en un plazo de tres meses desde la emisi칩n de
          esta factura,<br />
          se realizar치 mediante transferencia bancaria.
        </p>
      </footer>
    </div>

    <script>
      function generarPDF() {
        const facturaData = JSON.parse(localStorage.getItem("facturaData"));
        let totalFactura = 0;

        facturaData.productos.forEach((p) => {
          totalFactura += parseFloat(p.total);
        });
        let factura = {
          // Obtenemos todos los datos que ya est치n en pantalla
          numero: document.getElementById("numeroFactura").textContent,
          fecha: document.getElementById("fechaFactura").textContent,
          clienteNombre: document.getElementById("clienteNombre").textContent,
          clienteCorreo: document.getElementById("clienteCorreo").textContent,
          metodoPago: facturaData.metodoPago,
          paquete: facturaData.paquete,
          total: totalFactura,
          comentario: facturaData.comentario,
        };
        // Enviamos los datos al PHP por POST
        console.log(factura);
        fetch("../php/facturas_pdf.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(factura),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.exito) {
              alert("Factura PDF generada correctamente");
              var link = document.createElement("a");
              link.href = data.url;
              link.download = "factura.pdf";
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            } else {
              alert("Error al generar el PDF");
            }
          })
          .catch((error) => console.error("Error:", error));
      }
    </script>
    <div class="acciones-factura">
      <button id="btnGenerarPDF" class="btn-pdf" onclick="generarPDF()">
        游늯 Generar PDF
      </button>

      <button id="btnWhatsApp" class="btn-whatsapp" onclick="enviarPorWhatsApp()">
        游님 Enviar por WhatsApp
      </button>
    </div>

    <script src="../js/global-script.js"></script>
    <script src="factura.js"></script>
  </body>
</html>
